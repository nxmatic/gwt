name: 'Setup GWT Dev Environment'
description: 'Checks out GWT and GWT Tools, sets up Nix and Cachix'
inputs:
  cachix-auth-token:
    description: 'Cachix auth token'
    required: true
  github-token:
    description: 'Github token'
    required: true
runs:
  using: "composite"
  steps:
    - name: Prepare Nix environment
      id: setenv
      run: |
        : check for nix backup file
        set -ex -o pipefail
        cat <<! | cut -c 3- | tee -a "$GITHUB_OUTPUT"
          nix-installed=$( [[ -f "/etc/bash.bashrc.backup-before-nix" ]] && echo true || echo false )
        !
        cat <<! | cut -c 3- | tee -a "$GITHUB_PATH"
          /home/runner/.nix-profile/bin
          /nix/var/nix/profiles/default/bin
        !
        cat <<! | cut -c 3- | tee -a "$GITHUB_ENV"
          NIX_PATH=$HOME/.nix-profile/bin
          NIX_CONFIG=access-tokens = github.com=${GITHUB_TOKEN}
          CACHIX_AUTH_TOKEN=${CACHIX_AUTH_TOKEN}
          GITHUB_TOKEN=${GITHUB_TOKEN}
        !
      shell: bash -xe -o pipefail {0}
      env:
        CACHIX_AUTH_TOKEN: ${{ inputs.cachix-auth-token }}
        GITHUB_TOKEN: ${{ inputs.github-token }}

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      if: steps.setenv.outputs.nix-installed == 'false'
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
